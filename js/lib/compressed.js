function getRandomNumber(t){return t>1?Math.floor(Math.random()*Number(t)):0}function distance(t,e,a,s){return Math.abs(t-a)+Math.abs(e-s)}function isInArray(t,e){return!(getCoordinatesIndex(t,e)<0)}function getCoordinatesIndex(t,e){var a=-1;return e.some(function(e,s){return e[0]===t[0]&&e[1]===t[1]&&(a=s,!0)}),a}var Handle=function(t,e){this.playerTurn=function(t,e,a,s){switch(t.key){case"ArrowUp":s.showNextPossibleStep([s.nextStep.x,s.nextStep.y-1]);break;case"ArrowRight":s.showNextPossibleStep([s.nextStep.x+1,s.nextStep.y]);break;case"ArrowDown":s.showNextPossibleStep([s.nextStep.x,s.nextStep.y+1]);break;case"ArrowLeft":s.showNextPossibleStep([s.nextStep.x-1,s.nextStep.y]);break;case"Enter":return s.hidePlayerRange(a),s.hidePlayer(a),s.hideWeapons(e.weapons),e.actionMove(a,[s.nextStep.x,s.nextStep.y],s.nextStep.path),s.nextStep.updateOrigin(e.getOpponnent(a)),s.showPlayer(a),s.showPlayerRange(e.getOpponnent(a)),s.showWeapons(e.weapons),distance(a.x,a.y,e.getOpponnent(a).x,e.getOpponnent(a).y)<2&&!e.battleModeState?e.state===e.states.PLAYERONE_TURN?e.states.PLAYERTWO_BATTLEMODE:e.states.PLAYERONE_BATTLEMODE:e.state===e.states.PLAYERONE_TURN?e.states.PLAYERTWO_TURN:e.states.PLAYERONE_TURN;case"q":return e.states.GAMEOVER}return e.state},this.decision=function(t,e,a){return t.battleModeState?t.battleModeState?(e.updateBattleMode(a),t.actionBattle(t.playerOne,t.playerTwo),t.updateBattleModeState(t.battleModeStates.OFF),t.playerOne.power<=0||t.playerTwo.power<=0?t.states.GAMEOVER:t.state===t.states.PLAYERONE_BATTLEMODE?t.states.PLAYERTWO_TURN:t.states.PLAYERONE_TURN):void 0:(t.updateBattleModeState(t.battleModeStates.ON),e.updateBattleMode(a),t.state===t.states.PLAYERONE_BATTLEMODE?t.states.PLAYERTWO_BATTLEMODE:t.states.PLAYERONE_BATTLEMODE)},this.gameState=function(t,e){$(window).off(),e.modal.buttonAttack.off("click"),e.modal.buttonDefend.off("click");var a=this;switch(t.state){case t.states.START:console.log("Press Enter to begin "),$(window).keydown(function(s){"Enter"===s.key&&t.updateState(t.states.PLAYERONE_TURN),a.gameState(t,e)});break;case t.states.PLAYERONE_TURN:e.updateGameInformation(t.playerOne,t.playerTwo,t),$(window).keydown(function(s){t.updateState(a.playerTurn(s,t,t.playerOne,e)),a.gameState(t,e)});break;case t.states.PLAYERTWO_TURN:e.updateGameInformation(t.playerOne,t.playerTwo,t),$(window).keydown(function(s){t.updateState(a.playerTurn(s,t,t.playerTwo,e)),a.gameState(t,e)});break;case t.states.PLAYERONE_BATTLEMODE:e.updateGameInformation(t.playerOne,t.playerTwo,t),e.modal.setTitle(t.playerOne.customClass),e.modal.window.fadeIn(),e.modal.buttonAttack.on("click",function(s){t.updateState(a.decision(t,t.playerOne,t.decisions.ATTACK)),e.modal.window.fadeOut(),a.gameState(t,e)}),e.modal.buttonDefend.on("click",function(s){t.updateState(a.decision(t,t.playerOne,t.decisions.DEFEND)),e.modal.window.fadeOut(),a.gameState(t,e)});break;case t.states.PLAYERTWO_BATTLEMODE:e.updateGameInformation(t.playerOne,t.playerTwo,t),e.modal.setTitle(t.playerTwo.customClass),e.modal.window.fadeIn(),e.modal.buttonAttack.on("click",function(s){t.updateState(a.decision(t,t.playerTwo,t.decisions.ATTACK)),e.modal.window.fadeOut(),a.gameState(t,e)}),e.modal.buttonDefend.on("click",function(s){t.updateState(a.decision(t,t.playerTwo,t.decisions.DEFEND)),e.modal.window.fadeOut(),a.gameState(t,e)});break;case t.states.GAMEOVER:e.updateGameInformation(t.playerOne,t.playerTwo,t),console.log("Press Q to exit program"),$(window).keydown(function(s){"q"===s.key&&t.updateState(t.states.QUIT),a.gameState(t,e)});break;case 6:console.log("Game Exit - game state:",t.state)}}};$(document).ready(function(){var t=new Game;t.init(10,3,100,1,15,4);var e=new Display;e.init(t),(new Handle).gameState(t,e)});var Display=function(){this.init=function(t){this.classNames={playerOne:t.playerOne.customClass,playerTwo:t.playerTwo.customClass,nextStep:"step",obstacle:"obstacle",weapon:"weapon",range:"range",path:"path"},this.nextStep=new NextStep,this.nextStep.init(t.playerOne),this.board=this.generateBoard(t.board.fields,t.obstacles),this.showBoard(this.board),this.showPlayer(t.playerOne),this.showPlayer(t.playerTwo),this.showPlayerRange(t.playerOne),this.showWeapons(t.weapons),this.modal=new Modal,this.board.append(this.modal.window.hide())},this.generateBoard=function(t,e){for(var a=$("<div>"),s=0;s<t.length;s++){for(var i=$("<div>").addClass("row"),n=0;n<t.length;n++){var o=$("<div>").addClass(isInArray([n,s],e)?"field "+this.classNames.obstacle:"field");o.attr("id","field-"+n+s),o.append($("<div>").addClass("background").append($("<div>").addClass("object"))),i.append(o)}a.append(i)}return a},this.showBoard=function(t){var e=$("#board");e.html(""),e.append(t)},this.showPlayer=function(t){addClassName([t.x,t.y],t.customClass)},this.hidePlayer=function(t){this.nextStep.path.forEach(function(t){removeClassName([t[0],t[1]],this.classNames.path)},this),removeClassName([this.nextStep.x,this.nextStep.y],this.classNames.nextStep),removeClassName([t.x,t.y],t.customClass)},this.showPlayerRange=function(t){for(var e=0;e<t.possibleMoves.length;e++){var a=$("#field-".concat(t.possibleMoves[e][0],t.possibleMoves[e][1]));a.hasClass(this.classNames.range)||a.addClass(this.classNames.range)}},this.hidePlayerRange=function(t){for(var e=0;e<t.possibleMoves.length;e++){var a=$("#field-".concat(t.possibleMoves[e][0],t.possibleMoves[e][1]));a.hasClass(this.classNames.range)&&a.removeClass(this.classNames.range)}},this.showNextPossibleStep=function(t){if(this.nextStep.isPossible(t)){removeClassName([this.nextStep.x,this.nextStep.y],this.classNames.nextStep);var e=this.classNames.path;this.nextStep.path.forEach(function(t){removeClassName([t[0],t[1]],e)}),this.nextStep.updatePosition(t),this.nextStep.path.forEach(function(t){addClassName([t[0],t[1]],e)}),addClassName([this.nextStep.x,this.nextStep.y],this.classNames.nextStep)}},this.showWeapons=function(t){for(var e=0;e<t.length;e++)addClassName([t[e].x,t[e].y],t[e].weapon.model)},this.hideWeapons=function(t){for(var e=0;e<t.length;e++)removeClassName([t[e].x,t[e].y],t[e].weapon.model)},this.toggleActive=function(t,e,a){a.state>a.states.START&&(a.state===a.states.PLAYERONE_TURN||a.state===a.states.PLAYERONE_BATTLEMODE?(t.addClass("active"),e.removeClass("active")):a.state!==a.states.PLAYERTWO_TURN&&a.state!==a.states.PLAYERTWO_BATTLEMODE||(e.addClass("active"),t.removeClass("active")))},this.updateGameInformation=function(t,e,a){var s=$("#informations").html(""),i=$("<div>").addClass("player"),n=$("<div>").addClass("playerName").text("Player One"),o=$("<div>").addClass("power").text("Power: "),h=$("<div>").addClass("power").text(t.power),r=$("<div>").addClass("weapon").text("Weapon:"),d=$("<div>").addClass("weapon").text(100*-t.weapon.damage+"%"),p=$("<div>").addClass("turn").text(a.urnCounter),l=$("<div>").addClass("player"),c=$("<div>").addClass("playerName").text("Player Two"),u=$("<div>").addClass("power").text("Power:"),y=$("<div>").addClass("power").text(e.power),f=$("<div>").addClass("weapon").text("Weapon:"),w=$("<div>").addClass("weapon").text(100*-e.weapon.damage+"%");this.toggleActive(i,l,a),s.append(i.append(n).append(o).append(h).append(r).append(d)).append(p).append(l.append(c).append(u).append(y).append(f).append(w))}},addClassName=function(t,e){if(t[0]>=0&&t[1]>=0){var a=$("#field-".concat(t[0],t[1]));a.hasClass(e)||a.addClass(e)}},removeClassName=function(t,e){var a=$("#field-".concat(t[0],t[1]));a.hasClass(e)&&a.removeClass(e)},Modal=function(){this.buttonAttack=$("<button>").addClass("button attack").text("Attack".toUpperCase()),this.buttonDefend=$("<button>").addClass("button defend").text("Defend".toUpperCase()),this.titleText=$("<h1>").addClass("title"),this.desicionPrompt=$("<div>").addClass("prompt").text("Select battle mode"),this.window=$('<div id="decision">'),this.window.addClass("modal").append(this.titleText).append(this.desicionPrompt).append(this.buttonAttack).append(this.buttonDefend),this.setTitle=function(t){this.titleText.text(t)}},Board=function(){this.fieldClasses={empty:"available",obstacle:"unavailable",player:"player",weapon:"weapon"},this.init=function(t){this.size=t||10,this.fields=[];for(var e=0;e<this.size;e++){for(var a=[],s=0;s<this.size;s++)a.push(this.fieldClasses.empty);this.fields.push(a)}},this.randomFieldList=function(t){var e=this.size*this.size/4;if(t<e&&t>=1){var a=[[getRandomNumber(this.size),getRandomNumber(this.size)]];if(t>1)for(var s=1;s<t;){var i=[getRandomNumber(this.size),getRandomNumber(this.size)];isInArray(i,a)||(a.push(i),s++)}return a}return console.log(Error('Quantity of random indexes: " + quantity + " is greater then max: '+e)),[]}},Player=function(){this.init=function(t,e,a,s,i){this.x=t[0],this.y=t[1],this.rangeLimit=e||3,this.possibleMoves=[],this.power=a||100,this.weapon=s,this.customClass=i,this.defend=!1},this.updatePossibleMoves=function(t,e){for(var a={x:Math.min(Math.abs(this.x-this.rangeLimit),0),y:Math.min(Math.abs(this.y-this.rangeLimit),0)},s={x:Math.min(this.x+this.rangeLimit,t.length-1),y:Math.min(this.y+this.rangeLimit,t[0].length-1)},i=[],n=this.y;n>=a.y;n--)if(distance(this.x,this.y,this.x,n)<=this.rangeLimit){if(isInArray([this.x,n],e))break;i.push([this.x,n])}for(var o=this.x;o<=s.x;o++)if(distance(this.x,this.y,o,this.y)<=this.rangeLimit){if(isInArray([o,this.y],e))break;i.push([o,this.y])}for(n=this.y;n<=s.y;n++)if(distance(this.x,this.y,this.x,n)<=this.rangeLimit){if(isInArray([this.x,n],e))break;i.push([this.x,n])}for(o=this.x;o>=a.x;o--)if(distance(this.x,this.y,o,this.y)<=this.rangeLimit){if(isInArray([o,this.y],e))break;i.push([o,this.y])}this.possibleMoves=i},this.updatePosition=function(t,e){this.x=e[0],this.y=e[1]},this.positonIsPossible=function(t){return isInArray([t[0],t[1]],this.possibleMoves)},this.updatePower=function(t){void 0!==t&&(this.power=t)},this.updateWeapon=function(t){this.weapon=t},this.updateBattleMode=function(t){this.defend=t}},NextStep=function(){this.init=function(t){this.origin=t,this.distance=0,this.stepLimit=t.rangeLimit+1,this.x=this.origin.x,this.y=this.origin.y,this.path=[[this.x,this.y]]},this.isPossible=function(t){return isInArray(t,this.origin.possibleMoves)},this.updatePosition=function(t){var e=getCoordinatesIndex(t,this.path);e<0?this.path.length<this.stepLimit&&(this.path.push(t),this.x=t[0],this.y=t[1],this.distance=distance(this.x,this.y,this.origin.x,this.origin.y)):(this.path=this.path.slice(0,e+1),this.x=t[0],this.y=t[1],this.distance=distance(this.x,this.y,this.origin.x,this.origin.y))},this.updateOrigin=function(t){this.origin=t,this.distance=0,this.x=this.origin.x,this.y=this.origin.y,this.path=[[this.x,this.y]]}},Weapon=function(t,e){this.damage=t||1,this.model=e||"default"};Weapon.prototype.update=function(t){this.damage=t.damage,this.model=t.model};var Game=function(){this.init=function(t,e,a,s,i,n){this.initialPower=a||100,this.turnCounter=0,this.board=new Board,this.board.init(t),this.defaultWeapon=new Weapon(s,"default");var o=this.board.randomFieldList(2+i+n);this.obstacles=o.slice(2,o.length-n).sort();var h=[];o.slice(o.length-n).sort().forEach(function(t,e){var a=new Weapon(s*(e+2),"weapon"+(e+2));h.push({x:t[0],y:t[1],weapon:a})}),this.weapons=h,this.playerOne=new Player,this.playerOne.init(o[0],e,this.initialPower,this.defaultWeapon,"playerOne"),this.playerTwo=new Player,this.playerTwo.init(o[1],e,this.initialPower,this.defaultWeapon,"playerTwo"),this.playerOne.updatePossibleMoves(this.board.fields,this.obstacles.concat([[this.playerTwo.x,this.playerTwo.y]])),this.playerTwo.updatePossibleMoves(this.board.fields,this.obstacles.concat([[this.playerOne.x,this.playerOne.y]])),this.states={START:0,PLAYERONE_TURN:1,PLAYERTWO_TURN:2,PLAYERONE_BATTLEMODE:3,PLAYERTWO_BATTLEMODE:4,GAMEOVER:5,QUIT:6},this.battleModeStates={ON:!0,OFF:!1},this.decisions={ATTACK:!1,DEFEND:!0},this.state=this.states.START,this.battleModeState=this.battleModeStates.OFF},this.getOpponnent=function(t){return t===this.playerOne?this.playerTwo:this.playerOne},this.updatePlayerWeaponOnPath=function(t,e){for(var a=0;a<e.length;a++)for(var s=0;s<this.weapons.length;s++)if(e[a][0]===this.weapons[s].x&&e[a][1]===this.weapons[s].y)if(t.weapon.model===this.defaultWeapon.model)t.updateWeapon(this.weapons[s].weapon),this.weapons[s].x=-1,this.weapons[s].y=-1;else if(a>0){var i=t.weapon;t.updateWeapon(this.weapons[s].weapon),this.weapons[s].weapon=i}},this.actionMove=function(t,e,a){t.updatePosition(this.board.fields,e),this.updatePlayerWeaponOnPath(t,a),t.updatePossibleMoves(this.board.fields,this.obstacles.concat([[this.getOpponnent(t).x,this.getOpponnent(t).y]])),this.getOpponnent(t).updatePossibleMoves(this.board.fields,this.obstacles.concat([[t.x,t.y]])),this.turnCounter++},this.actionBattle=function(t,e){var a=this.initialPower*this.playerTwo.weapon.damage/10,s=this.initialPower*this.playerOne.weapon.damage/10;t.defend?e.defend||(this.playerOne.updatePower(this.playerOne.power-.5*a),this.playerTwo.updateWeapon(this.defaultWeapon)):e.defend?(this.playerTwo.updatePower(this.playerTwo.power-.5*s),this.playerOne.updateWeapon(this.defaultWeapon)):(this.playerOne.updatePower(this.playerOne.power-a),this.playerOne.updateWeapon(this.defaultWeapon),this.playerTwo.updatePower(this.playerTwo.power-s),this.playerTwo.updateWeapon(this.defaultWeapon))},this.updateState=function(t){this.state=t},this.updateBattleModeState=function(t){this.battleModeState=t}};